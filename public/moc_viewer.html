<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oberth Nozzle Design</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
    <header>
        <div class="container">
            <h1>Oberth Propulsion Suite</h1>
            <nav>
                <a href="index.html">Performance Analysis</a>
                <a href="moc_viewer.html" class="active">Nozzle Design (MOC)</a>
            </nav>
        </div>
    </header>

    <main class="container">
        <section class="card">
            <h2>Method of Characteristics (MOC) Design</h2>
            <p>Generate optimal supersonic bell nozzle contours.</p>

            <form id="moc-form">
                <div class="form-group">
                    <label for="expansion">Expansion Ratio ($\epsilon$)</label>
                    <input type="number" id="expansion" value="25.0" step="0.1">
                </div>

                <div class="form-group">
                    <label for="gamma">Specific Heat Ratio ($\gamma$)</label>
                    <input type="number" id="gamma" value="1.2" step="0.01">
                </div>

                <div class="form-group">
                    <label for="lines">Characteristic Lines</label>
                    <input type="number" id="lines" value="20" step="1">
                </div>

                <button type="submit" class="btn">Generate Contour</button>
            </form>
        </section>

        <section class="card results-section" style="display:none;" id="results-container">
            <h3>Characteristic Net</h3>
            <div id="plot-area"></div>
        </section>
    </main>

    <script>
        document.getElementById('moc-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const expansion = parseFloat(document.getElementById('expansion').value);
            const gamma = parseFloat(document.getElementById('gamma').value);
            const lines = parseInt(document.getElementById('lines').value);

            try {
                const response = await fetch('/api/nozzle', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        expansion_ratio: expansion,
                        gamma: gamma,
                        lines: lines
                    })
                });

                if (!response.ok) throw new Error('API Request failed');

                const data = await response.json();
                renderPlot(data);

            } catch (error) {
                console.error(error);
                alert('Error generating nozzle.');
            }
        });

        function renderPlot(data) {
            document.getElementById('results-container').style.display = 'block';
            const plotArea = d3.select("#plot-area");
            plotArea.selectAll("*").remove();

            const width = 800;
            const height = 400;
            const margin = {top: 20, right: 20, bottom: 40, left: 50};

            const svg = plotArea.append("svg")
                .attr("width", "100%")
                .attr("height", "100%")
                .attr("viewBox", `0 0 ${width} ${height}`);

            const xExtent = d3.extent(data.contour, d => d[0]);
            const yExtent = d3.extent(data.contour, d => d[1]);

            // Adjust yExtent to include negative (symmetric)
            const yMax = Math.max(Math.abs(yExtent[0] || 0), Math.abs(yExtent[1] || 1));
            const xMax = xExtent[1] || 10;

            const xScale = d3.scaleLinear()
                .domain([0, xMax])
                .range([margin.left, width - margin.right]);

            const yScale = d3.scaleLinear()
                .domain([-yMax * 1.5, yMax * 1.5])
                .range([height - margin.bottom, margin.top]);

            // Axis
            const xAxis = d3.axisBottom(xScale);
            const yAxis = d3.axisLeft(yScale);

            svg.append("g")
                .attr("transform", `translate(0,${height - margin.bottom})`)
                .call(xAxis);

            svg.append("g")
                .attr("transform", `translate(${margin.left},0)`)
                .call(yAxis);

            // Draw Wall
            const lineGenerator = d3.line()
                .x(d => xScale(d[0]))
                .y(d => yScale(d[1]));

            const wallPath = lineGenerator(data.contour);
            const wallPathBottom = lineGenerator(data.contour.map(d => [d[0], -d[1]]));

            svg.append("path")
                .attr("d", wallPath)
                .attr("fill", "none")
                .attr("stroke", "black")
                .attr("stroke-width", 2);

            svg.append("path")
                .attr("d", wallPathBottom)
                .attr("fill", "none")
                .attr("stroke", "black")
                .attr("stroke-width", 2);

            // Draw Mesh (Characteristics)
            if (data.mesh) {
                data.mesh.forEach(line => {
                    svg.append("line")
                        .attr("x1", xScale(line[0][0]))
                        .attr("y1", yScale(line[0][1]))
                        .attr("x2", xScale(line[1][0]))
                        .attr("y2", yScale(line[1][1]))
                        .attr("stroke", "blue")
                        .attr("stroke-opacity", 0.3);

                    svg.append("line")
                        .attr("x1", xScale(line[0][0]))
                        .attr("y1", yScale(-line[0][1]))
                        .attr("x2", xScale(line[1][0]))
                        .attr("y2", yScale(-line[1][1]))
                        .attr("stroke", "blue")
                        .attr("stroke-opacity", 0.3);
                });
            }
        }
    </script>
</body>
</html>
